{% extends 'base.html.twig' %}

{% block title %}Feedbacks de l'offre {{ offerType|capitalize }}{% endblock %}

{% block body %}
<div class="section bg-light py-5">
  <div class="container">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>
        <i class="fa fa-comments text-info"></i>
        Feedbacks - {{ offerType|capitalize }} n¬∞{{ offerId }}
      </h2>
      <a href="{{ path('feedback_index') }}" class="btn btn-secondary">
        ‚¨ÖÔ∏è Retour aux offres
      </a>
    </div>

    {% if feedbacks is not empty %}
      <div class="row g-2 mb-4">
        <div class="col-md-4">
          <select id="sort-select" class="form-select">
            <option value="date">üìÖ Date</option>
            <option value="rating">‚≠ê Note</option>
          </select>
        </div>

        <div class="col-md-3">
          <select id="dir-select" class="form-select">
            <option value="ASC">‚¨ÜÔ∏è Croissant</option>
            <option value="DESC">‚¨áÔ∏è D√©croissant</option>
          </select>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle shadow-sm">
          <thead class="table-dark text-center">
            <tr>
              <th>Utilisateur</th>
              <th>Message</th>
              <th>Note</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="feedback-table-body">
          </tbody>
        </table>
      </div>

      <div id="pagination" class="text-center mt-4"></div>
    {% else %}
      <div class="alert alert-warning text-center">
        üö´ Aucun feedback trouv√© pour cette offre.
      </div>
    {% endif %}

  </div>
</div>

{% if feedbacks is not empty %}
<script>
  const feedbacks = [
    {% for f in feedbacks %}
      {
        user: "{{ f.userid.email|e('js') }}",
        message: "{{ f.message|e('js') }}",
        rating: {{ f.rating }},
        date: "{{ f.date ? f.date|date('Y-m-d') : '‚Äî' }}"
      },
    {% endfor %}
  ];

  const itemsPerPage = 5;
  let currentPage = 1;

  function sortFeedbacks(sortKey, direction) {
    return feedbacks.slice().sort((a, b) => {
      if (sortKey === 'date') {
        const d1 = new Date(a.date);
        const d2 = new Date(b.date);
        return direction === 'ASC' ? d1 - d2 : d2 - d1;
      } else if (sortKey === 'rating') {
        return direction === 'ASC' ? a.rating - b.rating : b.rating - a.rating;
      }
      return 0;
    });
  }

  function renderTable(page, sorted) {
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const sliced = sorted.slice(start, end);

    const tableBody = document.getElementById('feedback-table-body');
    tableBody.innerHTML = '';

    sliced.forEach(fb => {
      const row = `
        <tr>
          <td class="text-center">${fb.user}</td>
          <td>${fb.message}</td>
          <td class="text-center">${fb.rating}/5</td>
          <td class="text-center">${fb.date}</td>
        </tr>
      `;
      tableBody.innerHTML += row;
    });
  }

  function renderPagination(totalItems, sorted) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const container = document.getElementById('pagination');
    container.innerHTML = '';

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.className = 'btn btn-sm mx-1 ' + (i === currentPage ? 'btn-primary' : 'btn-outline-primary');
      btn.addEventListener('click', () => {
        currentPage = i;
        renderTable(currentPage, sorted);
        renderPagination(sorted.length, sorted);
      });
      container.appendChild(btn);
    }
  }

  function updateDisplay() {
    const sort = document.getElementById('sort-select').value;
    const dir = document.getElementById('dir-select').value;
    const sorted = sortFeedbacks(sort, dir);
    currentPage = 1;
    renderTable(currentPage, sorted);
    renderPagination(sorted.length, sorted);
  }

  document.addEventListener('DOMContentLoaded', function () {
    updateDisplay();
    document.getElementById('sort-select').addEventListener('change', updateDisplay);
    document.getElementById('dir-select').addEventListener('change', updateDisplay);
  });
</script>
{% endif %}
{% endblock %}
