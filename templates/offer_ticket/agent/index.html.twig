{% extends 'base.html.twig' %}

{% block title %}Gestion des Tickets{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .ticket-container {
        padding: 2rem;
    }
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .page-title {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .badge-count {
        background-color: #6c757d;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
    }
    .btn-create {
        background-color: #28a745;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .btn-create:hover {
        background-color: #218838;
        color: white;
    }
    .search-filter-container {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }
    .search-box {
        position: relative;
        margin-bottom: 1rem;
    }
    .search-box i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
    .search-box input {
        padding-left: 2.5rem;
    }
    .filter-section {
        margin-top: 1.5rem;
    }
    .filter-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    .ticket-class-filter, .ticket-type-filter, .agency-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .ticket-card {
        border: none;
        border-radius: 0.5rem;
        overflow: hidden;
        transition: transform 0.2s;
        height: 100%;
    }
    .ticket-card:hover {
        transform: translateY(-5px);
    }
    .ticket-image {
        height: 200px;
        object-fit: cover;
    }
    .ticket-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
    }
    .ticket-price {
        font-size: 1.25rem;
        font-weight: 600;
        color: #28a745;
    }
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    .btn-view, .btn-edit, .btn-delete {
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .btn-view {
        background-color: #17a2b8;
        color: white;
    }
    .btn-edit {
        background-color: #ffc107;
        color: #212529;
    }
    .btn-delete {
        background-color: #dc3545;
        color: white;
    }
    .no-tickets {
        text-align: center;
        padding: 3rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
    }
    .alert {
        margin-bottom: 1rem;
    }
    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
</style>
{% endblock %}

{% block body %}
<div class="ticket-container">
    {% for message in app.flashes('success') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}

    {% for message in app.flashes('error') %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}

    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-ticket-alt"></i> Liste des Tickets
            <span class="badge-count" id="ticketCount">{{ tickets|length }}</span>
        </h1>
        <a href="{{ path('app_offer_ticket_action', {'action': 'new'}) }}" class="btn-create">
            <i class="fas fa-plus"></i> Nouveau Ticket
        </a>
    </div>

    <div class="search-filter-container">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" class="form-control" placeholder="Rechercher par compagnie ou ville..." 
                   value="{{ search|default('') }}">
        </div>
        
        <div class="filter-section">
            <div class="filter-title">Filtrer par classe:</div>
            <div class="ticket-class-filter">
                {% for class in ['Economy', 'Business', 'First'] %}
                    <input type="checkbox" class="ticket-class-checkbox" id="class-{{ class }}" 
                           value="{{ class }}"
                           {% if class in selected_ticket_classes %}checked{% endif %}>
                    <label for="class-{{ class }}" class="ticket-class-label {{ class|lower }}">
                        {{ class }}
                    </label>
                {% endfor %}
            </div>
            
            <div class="filter-title">Filtrer par type:</div>
            <div class="ticket-type-filter">
                {% for type in ['One-way', 'Round-trip'] %}
                    <input type="checkbox" class="ticket-type-checkbox" id="type-{{ type }}" 
                           value="{{ type }}"
                           {% if type in selected_ticket_types %}checked{% endif %}>
                    <label for="type-{{ type }}" class="ticket-type-label {{ type|lower }}">
                        {{ type }}
                    </label>
                {% endfor %}
            </div>
            
            <div class="filter-title">Filtrer par agence:</div>
            <div class="agency-filter">
                {% for agency in all_agencies %}
                    <input type="checkbox" class="agency-checkbox" id="agency-{{ agency.id }}" 
                           value="{{ agency.id }}"
                           {% if agency.id in selected_agencies|map(v => v|number_format) %}checked{% endif %}>
                    <label for="agency-{{ agency.id }}" class="agency-label">
                        {{ agency.name }}
                    </label>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="row" id="ticketsContainer">
        {% include 'offer_ticket/agent/_tickets_list.html.twig' %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const ticketClassCheckboxes = document.querySelectorAll('.ticket-class-checkbox');
    const ticketTypeCheckboxes = document.querySelectorAll('.ticket-type-checkbox');
    const agencyCheckboxes = document.querySelectorAll('.agency-checkbox');
    const ticketsContainer = document.getElementById('ticketsContainer');
    const badgeCount = document.getElementById('ticketCount');

    function loadResults() {
        const params = new URLSearchParams();
        if (searchInput.value) params.append('search', searchInput.value);
        
        const selectedClasses = Array.from(ticketClassCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        if (selectedClasses.length) params.append('ticketClasses[]', selectedClasses);
        
        const selectedTypes = Array.from(ticketTypeCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        if (selectedTypes.length) params.append('ticketTypes[]', selectedTypes);
        
        const selectedAgencies = Array.from(agencyCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        if (selectedAgencies.length) params.append('agencies[]', selectedAgencies);

        fetch(`{{ path('app_offer_ticket_index') }}?${params.toString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'text/html'
            }
        })
        .then(response => response.text())
        .then(html => {
            ticketsContainer.innerHTML = html;
            updateTicketCount();
        });
    }

    function updateTicketCount() {
        const ticketCount = document.querySelectorAll('#ticketsContainer .col-md-4').length;
        badgeCount.textContent = ticketCount;
    }

    searchInput.addEventListener('input', function() {
        clearTimeout(this.timer);
        this.timer = setTimeout(loadResults, 300);
    });

    ticketClassCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', loadResults);
    });

    ticketTypeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', loadResults);
    });

    agencyCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', loadResults);
    });

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('search') || urlParams.has('ticketClasses') || urlParams.has('ticketTypes') || urlParams.has('agencies')) {
        loadResults();
    }
});
</script>
{% endblock %} 