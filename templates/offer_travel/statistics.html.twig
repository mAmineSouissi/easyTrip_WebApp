{% extends 'base.html.twig' %}

{% block title %}Statistiques des offres{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chart-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 30px;
            height: 100%;
        }
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        canvas {
            width: 100% !important;
            min-height: 300px;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container py-4">
    <h1 class="mb-4">Statistiques des offres</h1>

    <div class="row">
        <!-- Graphique 1: Nombre d'offres par agence (Bar) -->
        <div class="col-md-6 col-lg-4">
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-chart-bar me-2"></i>Offres par agence
                </div>
                <canvas id="offersByAgencyChart"></canvas>
            </div>
        </div>

        <!-- Graphique 2: CA par agence (Bar) -->
        <div class="col-md-6 col-lg-4">
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-euro-sign me-2"></i>Chiffre d'affaires par agence
                </div>
                <canvas id="revenueByAgencyChart"></canvas>
            </div>
        </div>

        <!-- Graphique 3: Offres par catégorie (Pie) -->
        <div class="col-md-6 col-lg-4">
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-chart-pie me-2"></i>Offres par catégorie
                </div>
                <canvas id="offersByCategoryChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Couleurs personnalisées
            const colors = [
                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', 
                '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'
            ];

            // 1. Graphique des offres par agence (Bar)
            new Chart(
                document.getElementById('offersByAgencyChart'),
                {
                    type: 'bar',
                    data: {
                        labels: {{ offersByAgency.labels|json_encode|raw }},
                        datasets: [{
                            label: "Nombre d'offres",
                            data: {{ offersByAgency.data|json_encode|raw }},
                            backgroundColor: colors,
                            borderColor: colors.map(c => c.replace('0.6', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.parsed.y + " offres";
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                }
            );

            // 2. Graphique du CA par agence (Bar)
            new Chart(
                document.getElementById('revenueByAgencyChart'),
                {
                    type: 'bar',
                    data: {
                        labels: {{ revenueByAgency.labels|json_encode|raw }},
                        datasets: [{
                            label: "Chiffre d'affaires",
                            data: {{ revenueByAgency.data|json_encode|raw }},
                            backgroundColor: colors,
                            borderColor: colors.map(c => c.replace('0.6', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.parsed.y.toLocaleString('fr-FR') + " €";
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('fr-FR') + " €";
                                    }
                                }
                            }
                        }
                    }
                }
            );

            // 3. Graphique des offres par catégorie (Pie)
            new Chart(
                document.getElementById('offersByCategoryChart'),
                {
                    type: 'pie',
                    data: {
                        labels: {{ offersByCategory.labels|json_encode|raw }},
                        datasets: [{
                            data: {{ offersByCategory.data|json_encode|raw }},
                            backgroundColor: colors,
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((context.raw / total) * 100);
                                        return `${context.label}: ${context.raw} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                }
            );
        });
    </script>
{% endblock %}